import{g as T,d as f,w as p}from"./CSEEA0gy.js";import{w as d}from"./Um1MPQnS.js";class a extends Error{constructor(e,s,r){super(s),this.status=e,this.message=s,this.details=r,this.name="APIError"}}class S{baseURL;accessToken=null;refreshToken=null;isRefreshing=!1;refreshPromise=null;constructor(){this.baseURL=this.getBaseURL()}getBaseURL(){return typeof window<"u"?window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?"http://localhost:8080":`${window.location.protocol}//api.${window.location.hostname}`:"http://localhost:8080"}setTokens(e,s){this.accessToken=e,this.refreshToken=s}clearTokens(){this.accessToken=null,this.refreshToken=null,this.isRefreshing=!1,this.refreshPromise=null}getAccessToken(){return this.accessToken}async request(e,s={}){this.accessToken&&this.isTokenExpiringSoon()&&await this.refreshAccessToken();let r=await this.makeRequest(e,s);if(r.status===401&&this.refreshToken&&!this.isRefreshing)try{await this.refreshAccessToken(),r=await this.makeRequest(e,s)}catch{throw this.handleAuthenticationFailure(),new a(401,"Session expired. Please log in again.")}return this.handleResponse(r)}async makeRequest(e,s={}){const r=`${this.baseURL}${e}`,n={"Content-Type":"application/json",...s.headers};return this.accessToken&&(n.Authorization=`Bearer ${this.accessToken}`),fetch(r,{...s,headers:n})}async handleResponse(e){if(!e.ok){let s=`HTTP ${e.status}: ${e.statusText}`,r={};try{const n=await e.json();s=n.detail||n.message||s,r=n}catch{}throw new a(e.status,s,r)}if(e.status===204||e.headers.get("content-length")==="0")return{};try{return await e.json()}catch{throw new a(500,"Invalid JSON response from server")}}isTokenExpiringSoon(){if(!this.accessToken)return!1;try{const s=JSON.parse(atob(this.accessToken.split(".")[1])).exp*1e3,r=Date.now(),n=5*60*1e3;return s-r<n}catch{return!0}}async refreshAccessToken(){if(this.isRefreshing&&this.refreshPromise){await this.refreshPromise;return}if(!this.refreshToken)throw new a(401,"No refresh token available");this.isRefreshing=!0,this.refreshPromise=this.performTokenRefresh();try{await this.refreshPromise}finally{this.isRefreshing=!1,this.refreshPromise=null}}async performTokenRefresh(){try{const e=await fetch(`${this.baseURL}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:this.refreshToken})});if(!e.ok)throw new a(e.status,"Failed to refresh token");const s=await e.json();this.setTokens(s.access_token,s.refresh_token),typeof window<"u"&&window.dispatchEvent(new CustomEvent("token-refreshed",{detail:s}))}catch(e){throw this.clearTokens(),e}}handleAuthenticationFailure(){this.clearTokens(),typeof window<"u"&&(window.dispatchEvent(new CustomEvent("auth-failed")),window.location.pathname.includes("/login")||T("/login"))}async login(e){try{const s=await fetch(`${this.baseURL}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok){let n="Login failed";try{const g=await s.json();n=g.detail||g.message||n}catch{}throw new a(s.status,n)}const r=await s.json();return this.setTokens(r.access_token,r.refresh_token),r}catch(s){throw s instanceof a?s:new a(0,"Network error during login")}}async logout(){try{this.accessToken&&await this.request("/auth/logout",{method:"POST"})}catch(e){console.warn("Logout request failed:",e)}finally{this.clearTokens()}}async getCurrentUser(){return this.request("/auth/me")}async changePassword(e){await this.request("/auth/me/password",{method:"PUT",body:JSON.stringify(e)})}async getUserSessions(){return this.request("/auth/sessions")}async revokeSession(e){await this.request(`/auth/sessions/${e}`,{method:"DELETE"})}async registerUser(e){return this.request("/auth/register",{method:"POST",body:JSON.stringify(e)})}async getUsers(e,s=50,r=0){const n=new URLSearchParams({limit:s.toString(),offset:r.toString()});return e&&n.append("client_id",e),this.request(`/auth/users?${n}`)}async deleteUser(e){await this.request(`/auth/users/${e}`,{method:"DELETE"})}async getHealth(){return this.request("/health")}async getDetailedHealth(){return this.request("/health/detailed")}}const o=new S;function c(t){return t instanceof a||t instanceof Error?t.message:"An unexpected error occurred"}const A={user:null,isAuthenticated:!1,isLoading:!1,error:null,accessToken:null,refreshToken:null},h=p(A),L=f(h,t=>t.isAuthenticated),w=f(h,t=>t.user),R=f(h,t=>t.isLoading),b=f(h,t=>t.error);function i(t){h.update(e=>({...e,...t}))}function u(t){i({isLoading:t,error:null})}function k(t){i({error:t,isLoading:!1})}const l="email-router-tokens";function m(t,e){try{localStorage.setItem(l,JSON.stringify({accessToken:t,refreshToken:e,timestamp:Date.now()}))}catch(s){console.warn("Failed to save tokens to localStorage:",s)}}function U(){try{const t=localStorage.getItem(l);if(!t)return null;const{accessToken:e,refreshToken:s,timestamp:r}=JSON.parse(t),n=7*24*60*60*1e3;return Date.now()-r>n?(localStorage.removeItem(l),null):{accessToken:e,refreshToken:s}}catch(t){return console.warn("Failed to load tokens from localStorage:",t),localStorage.removeItem(l),null}}function v(){localStorage.removeItem(l)}class E{async initialize(){u(!0);try{const e=U();if(!e){u(!1);return}o.setTokens(e.accessToken,e.refreshToken);const s=await o.getCurrentUser();i({user:s,isAuthenticated:!0,accessToken:e.accessToken,refreshToken:e.refreshToken,isLoading:!1,error:null}),console.log("âœ… Auth initialized successfully")}catch(e){console.warn("âš ï¸ Auth initialization failed:",e),this.clearAuth()}}async login(e){u(!0);try{console.log("ðŸ” Attempting login for user:",e.username);const s=await o.login(e);console.log("âœ… Login successful, received tokens");const r=await o.getCurrentUser();return console.log("âœ… User info retrieved:",r.username),i({user:r,isAuthenticated:!0,accessToken:s.access_token,refreshToken:s.refresh_token,isLoading:!1,error:null}),m(s.access_token,s.refresh_token),console.log("ðŸŽ‰ Login completed successfully!"),{success:!0}}catch(s){const r=c(s);return console.error("âŒ Login failed:",r),k(r),this.clearAuth(),{success:!1,error:r}}}async logout(){u(!0);try{await o.logout(),console.log("âœ… Logout API call successful")}catch(e){console.warn("âš ï¸ Logout API call failed:",e)}this.clearAuth(),console.log("ðŸ” Logout completed"),T("/login")}clearAuth(){o.clearTokens(),v(),i({user:null,isAuthenticated:!1,accessToken:null,refreshToken:null,isLoading:!1,error:null})}async changePassword(e){u(!0);try{return await o.changePassword(e),i({isLoading:!1,error:null}),{success:!0}}catch(s){const r=c(s);return k(r),{success:!1,error:r}}}async refreshUserInfo(){if(d(L))try{const e=await o.getCurrentUser();i({user:e})}catch(e){console.warn("Failed to refresh user info:",e)}}async getUserSessions(){try{return{success:!0,sessions:(await o.getUserSessions()).sessions}}catch(e){return{success:!1,error:c(e)}}}async revokeSession(e){try{return await o.revokeSession(e),{success:!0}}catch(s){return{success:!1,error:c(s)}}}async registerUser(e){try{return{success:!0,user:await o.registerUser(e)}}catch(s){return{success:!1,error:c(s)}}}async getUsers(e){try{return{success:!0,users:await o.getUsers(e)}}catch(s){return{success:!1,error:c(s)}}}async deleteUser(e){try{return await o.deleteUser(e),{success:!0}}catch(s){return{success:!1,error:c(s)}}}hasPermission(e){const s=d(w);if(!s)return!1;if(s.role==="super_admin")return!0;switch(s.role){case"client_admin":return["client:read","client:write","routing:read","routing:write","branding:read","branding:write","users:read","users:write"].includes(e);case"client_user":return["client:read","routing:read","branding:read"].includes(e);case"api_user":return["client:read"].includes(e);default:return!1}}canAccessClient(e){const s=d(w);return s?s.role==="super_admin"?!0:s.client_id===e:!1}}const y=new E;window.addEventListener("token-refreshed",t=>{const e=t.detail;i({accessToken:e.access_token,refreshToken:e.refresh_token}),m(e.access_token,e.refresh_token)}),window.addEventListener("auth-failed",()=>{y.logout()}),y.initialize();export{L as a,b,y as c,w as d,R as i};
//# sourceMappingURL=CfmmjSnu.js.map
